<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="autor" content="Omar Costa Hamido">
	<meta name="description" content="Ciencia Vitae is the mandatory CV platform for FCT grantees. This website contains a Ciencia Vitae XML export parser, that saves the content in a table format.">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<title>Ciencia Vitae XML parser</title>
	<style type="text/css">
		body{
			font-family: Avenir;
		}
		#parse {
			display: none; 
			background: lawngreen;
		}
		.tab {
			display: none;
		}
		table {
			border-collapse: collapse;
		}
		table, td, th {
			border: 1px solid black;
		}
		tr:nth-child(even) {
			background-color: #dddddd;
		}
	</style>
</head>
<body>
	<h1>Ciencia Vitae XML parser <a href="https://github.com/omarcostahamido/CienciaVitaeXMLparser" style="color: black;"><i class="fa-brands fa-github"></i></a></h1>
	<input type="file" id="fileinput" />
	<button id="parse" onclick="initialscope()"> PARSE! </button>
	<br>
	<br>
	<div id="tabs">
		<button onclick="openTab(event)">log</button>
		<button onclick="openTab(event)">identity</button>
		<button onclick="openTab(event)">degrees</button>
		<button onclick="openTab(event)">outputs</button>
		<button onclick="openTab(event)">services</button>
		<button onclick="openTab(event)">distinctions</button>
	</div>
	<div id="log" class="tab"><i>placeholder 1</i></div>
	<div id="identity" class="tab"><i>placeholder 2</i></div>
	<div id="degrees" class="tab"><i>placeholder 3</i></div>
	<div id="outputs" class="tab"><i>placeholder 4</i></div>
	<div id="services" class="tab"><i>placeholder 5</i></div>
	<div id="distinctions" class="tab"><i>placeholder 6</i></div>
    <script type="text/javascript">
		var content, parser, xmlDoc, depthspace, headers, current_column, previous_column;
		parser = new DOMParser();
		const space = "&nbsp;&nbsp;&nbsp;&nbsp;";
		var log = "";

		function readSingleFile(evt) {
			//Retrieve the first (and only!) File from the FileList object
			var f = evt.target.files[0]; 

			if (f) {
			  var r = new FileReader();
			  r.onload = function(e) { 
			      content = e.target.result;
			      console.log( "Got the file.\n" 
			            +"name: " + f.name + "\n"
			            +"type: " + f.type + "\n"
			            +"size: " + f.size + " bytes\n"
			            // + "starts with: " + content.substr(1, content.indexOf("\n"))
			            + "starts with: " + content.substr(1, 100)
			            + "..."
			            );  
			      xmlDoc = parser.parseFromString(content,"text/xml");
			      // document.getElementById('parse').value = content;
			      document.getElementById('parse').style.display = 'inline-block';
			  }
			  r.readAsText(f);
			  // print2console();
  
			  // document.getElementById("demo").innerHTML =
			  // xmlDoc.getElementsByTagName("title")[0].childNodes[0].nodeValue;

			} else { 
			  alert("Failed to load file");
			}
		}

		document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

		function indentation(depth){
			var result = "";
			for (var i = 1; i < depth; i++) {
				result += space;
			}
			return result;
		}
		function iterateAndPrint(elem,depth){
			if (elem.childNodes) {
				for (var i = 0, count = elem.childNodes.length, thisdepth = depth+1; i < count; i++) {
					if (elem.childNodes[i].nodeName != "#text") {
						// console.log(elem.childNodes[i].nodeName," depth: ",thisdepth);
						log += indentation(thisdepth)+elem.childNodes[i].nodeName+" depth: "+thisdepth+"<br>";
						iterateAndPrint(elem.childNodes[i],thisdepth);
					} else {
						// console.log(elem.innerHTML," depth: ",thisdepth);
						log += "<strong>"+indentation(thisdepth)+elem.innerHTML+"</strong>"+"<br>";
					}
				}
			}
		}

		function initialscope(){
			log = "";
			curr = xmlDoc.getElementsByTagName("curriculum:curriculum")[0];
			iterateAndPrint(curr,0);
			document.getElementById('log').innerHTML = log;
			parseIdentity();
		}

		function openTab(e) {
			var tabs = document.getElementsByClassName("tab");
			for (i = 0; i < tabs.length; i++) {
				tabs[i].style.display = "none";
			}
			document.getElementById(e.currentTarget.innerHTML).style.display = "block";
		}
		
		function parseIdentity(){
			log = "";
			log += "<table><tr><th>ID</th><th>full-name</th><th>citation-name</th><th>research-classification</th><th>topic</th><th>keywords</th></tr>";
			var cienciaID;
			var authorIdentifiers = xmlDoc.getElementsByTagName("author-identifier:author-identifiers")[0].childNodes;
			for (var i = 0; i < authorIdentifiers.length; i++) {
				if (authorIdentifiers[i].childNodes[0].innerHTML == "CiÃªncia ID") {
					cienciaID = authorIdentifiers[i].childNodes[1].innerHTML
				}
			}
			log += "<tr><td>"+cienciaID+"</td>";
			log += "<td>"+xmlDoc.getElementsByTagName("person-info:full-name")[0].innerHTML+"</td>";
			log += "<td>"+xmlDoc.getElementsByTagName("citation-name:citation-name")[0].innerHTML+"</td>";
			log += "<td>"+xmlDoc.getElementsByTagName("common:research-classification")[0].innerHTML+"</td>";
			log += "<td>"+xmlDoc.getElementsByTagName("domain-activity:topic")[0].innerHTML+"</td>";
			var keywords = xmlDoc.getElementsByTagName("common:keywords")[0].childNodes;
			var parsedKeywords = "";
			for (var i = 0; i < keywords.length; i++) {
				if (i>0) {parsedKeywords += ", "}
				parsedKeywords += keywords[i].innerHTML
			}
			log += "<td>"+parsedKeywords+"</td></tr></table>";
			document.getElementById('identity').innerHTML = log;
			parseOutputs(cienciaID);
		}

		function parseOutputs(cienciaID){
			log = "";
			var header = "<table><tr><th>ID</th><th>full-name</th><th>category</th><th>type</th>";
			headers = [];
			var outputs = xmlDoc.getElementsByTagName("output:outputs")[0].childNodes;
			for (var i = 0, count = outputs.length; i < count; i++) {
				log += "<tr><td>"+cienciaID+"</td>";
				log += "<td>"+xmlDoc.getElementsByTagName("person-info:full-name")[0].innerHTML+"</td>";
				log += "<td>"+outputs[i].childNodes[0].innerHTML+"</td>"; //category
				log += "<td>"+outputs[i].childNodes[1].innerHTML+"</td>"; //type
				current_column = 0;
				previous_column = "";
				outputDetails(outputs[i].childNodes[2]);
				log += "</tr>";
			}
			// console.log("headers: ",headers);
			for (var i = 0; i < headers.length; i++) {
				header += "<th>"+headers[i]+"</th>";
			}
			header += "</tr>";
			log = header+log+"</table>";
			document.getElementById('outputs').innerHTML = log;
			//complete trailing cells
			var tlenght = document.getElementById("outputs").childNodes[0].childNodes[0].childNodes[0].childNodes.length; //table > tbody > tr > th's
			console.log("tlenght: ",tlenght);
			var trows   = document.getElementById("outputs").childNodes[0].childNodes[0].childNodes.length;
			console.log("trows: ",trows);
			for (var i = 0; i < trows; i++) {
				// console.log("current_row #",i);
				var current_row = document.getElementById("outputs").childNodes[0].childNodes[0].childNodes[i];
				// console.log("current_row: ",current_row);
				var current_cell = current_row.childNodes.length;
				while (current_cell < tlenght) {
					current_row.insertCell(-1);
					// console.log("current_cell: ", current_cell);
					// console.log("added one cell");
					current_cell ++;
				}
			}
		}

		function outputDetails(node){
			if (node.childNodes) {
				for (var i = 0, count = node.childNodes.length; i < count; i++) {
					if (node.childNodes[i].nodeName != "#text") {
						//we need to continue digging deeper
						outputDetails(node.childNodes[i]);
					} else {
						//check the column name
						var cname = node.nodeName;
						//check where it is
						if (previous_column == cname) {
							log = log.slice(0,-5);
							log += ", "+node.innerHTML+"</td>";
						} else {
							var target = checkOuputColumns(cname);
							log += emptyCells(current_column,target)+"<td>"+node.innerHTML+"</td>";
							current_column = target;
							previous_column = cname;
						}
					}
				}
			}
		}

		function emptyCells(current,target){
			var result = "";
			for (var i = 1; i < (target-current); i++) {
				result += "<td></td>";
			}
			return result;
		}

		function checkOuputColumns(key){
			if (headers.indexOf(key)== -1) {
				headers.push(key)
			}
			return headers.indexOf(key);
		}

		function copytable(el) {
		    var urlField = document.getElementById(el)   
		    var range = document.createRange()
		    range.selectNode(urlField)
		    window.getSelection().addRange(range) 
		    document.execCommand('copy')
		}

    </script>
    <br>
    
</body>
</html>